{% load filters %}

<h3>Membership</h3>

{% if user.subscription is not None and user.subscription.owner != user %}
<div id="family-member-msg">
  You are a family member on {{user.subscription.owner | show_name}}'s membership.
</div>
{% endif %}

{% if user.subscription is None %}
  <div>
    <a id="show-membership-purchase"
       href="javascript:void(false)"
       onclick="toggle_element('purchase-subscription-form')">
      Become a member
    </a>
  </div>
{% elif user.subscription.membership_type == 'lifetime' %}
  <div id="membership-status-msg">Your membership is valid forever!</div>
{% else %}
  {% if user.subscription_is_current %}
  <div id="membership-status-msg">
    Your membership is valid until
    <span id="valid-until-timestamp">
      {% format_datetime user.subscription.valid_until none_ok=True %}
    </span>
  </div>
  {% else %}
  <div id="membership-status-msg">
    Your membership <b>expired</b> on
    <span id="valid-until-timestamp">
      {% format_datetime user.subscription.valid_until none_ok=True %}
    </span>
  </div>
  {% endif %}

  {% if user.subscription.owner == user %}
  <div id="family-members-wrapper" class="mt-3">
    <div class="mb-1"><b>Family Members</b></div>
    <ul id="family-member-list">
      {% for member in user.subscription.family_members.all %}
      <li class="family-member">
        <form
          class="remove-family-member-form"
          method="post"
          action="{% url 'remove-family-member' pk=user.subscription.pk %}"
        >
          {% csrf_token %}
          <input type="hidden" value="{{member.username}}" name="username">

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">{{member | show_name_and_email}}</span>
            <button type="submit" class="btn btn-danger">Remove</button>
          </div>
        </form>
      </li>
      {% endfor %}
      {% if user.subscription.family_members.count < 3 %}
      <li>
        <form
          id="add-family-member-form"
          method="post"
          action="{% url 'add-family-member' pk=user.subscription.pk %}"
        >
          {% csrf_token %}
          <div class="input-group input-group-sm">
            <input
              class="form-control no-full-width" type="email"
              name="username" type="email" required autocomplete="off"
            >
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </li>
      {% endif %}
    </ul>
  </div>

  <div id="show-membership-purchase-wrapper">
    <a
      id="show-membership-purchase"
      href="#purchase-subscription-form"
      data-bs-toggle="collapse"
      aria-expanded="false"
      aria-controls="purchase-subscription-form"
    >
      Renew your membership
    </a>
  </div>
  {% endif %}
{% endif %}

<form
  id="purchase-subscription-form"
  class="collapse ms-1"
  method="post"
  action="{% url 'purchase-subscription' pk=user.pk %}"
>
  {% csrf_token %}
  {% include 'utils/form_body.tmpl' with form=form %}

  <div class="redirect-info-msg mb-2">
    Clicking "Checkout" will redirect you to Stripe. <br>
    Please enter your payment info there.
  </div>
  <button type="submit" class="btn btn-primary">Checkout</button>
  <button
    id="hide-purchase-subscription"
    type="button"
    class="btn btn-light"
    data-bs-toggle="collapse"
    data-bs-target="#purchase-subscription-form"
    aria-controls="purchase-subscription-form"
  >
    Cancel
  </a>
</form>
